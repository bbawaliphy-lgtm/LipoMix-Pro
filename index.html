<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LipoMix Pro - Lipid Solution Calculator</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">

    <!-- iOS support -->
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script>
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("./service-worker.js")
            .then(() => console.log("Service Worker Registered"))
            .catch(err => console.error("Service Worker registration failed:", err));
        }
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            font-size: 1.8em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 0.9em;
        }

        /* Tab Navigation Styles */
        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 24px;
            font-size: 1em;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            color: #667eea;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .section-title {
            font-size: 1.2em;
            color: #667eea;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
            font-size: 0.95em;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .lipid-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
            align-items: end;
        }

        .add-lipid-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            margin-top: 10px;
            transition: background 0.3s;
        }

        .add-lipid-btn:hover {
            background: #5568d3;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s;
        }

        .remove-btn:hover {
            background: #c82333;
        }

        .calculate-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
        }

        .results {
            margin-top: 30px;
            padding: 20px;
            background: #e8f5e9;
            border-radius: 10px;
            display: none;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .result-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .result-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            margin-bottom: 8px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .result-label {
            font-weight: 600;
            color: #333;
        }

        .result-value {
            color: #667eea;
            font-weight: 700;
        }

        .chloroform-result {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .add-lipid-section {
            margin-top: 20px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
        }

        .add-lipid-form {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 10px;
            margin-top: 10px;
            align-items: end;
        }

        .save-lipid-btn {
            background: #2196f3;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            transition: background 0.3s;
            white-space: nowrap;
        }

        .save-lipid-btn:hover {
            background: #1976d2;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #667eea;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
        }

        td {
            font-size: 0.9em;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .highlight {
            background: #fff3cd;
            font-weight: 600;
        }

        footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: white;
            font-size: 0.9em;
        }

        footer a {
            color: white;
            text-decoration: none;
            font-weight: 600;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.5em;
            }

            .tab-container {
                flex-direction: column;
                gap: 5px;
            }
            
            .tab-btn {
                padding: 10px;
                text-align: left;
                border-left: 3px solid transparent;
                border-bottom: none;
            }
            
            .tab-btn.active {
                border-left-color: #667eea;
                border-bottom-color: transparent;
            }

            .lipid-row {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .input-row {
                grid-template-columns: 1fr;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }

            .section {
                padding: 15px;
            }

            table {
                font-size: 0.8em;
            }

            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="text-align: center; margin-bottom: 10px;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                <img src="icon-192.png" alt="LipoMix Logo" style="width: 42px; height: 42px; border-radius: 10px;">
                <h1 style="margin: 0; font-size: 1.9em; color: #333;">LipoMix Pro</h1>
            </div>
            <p style="margin-top: 6px; font-size: 0.85em; color: #555; font-weight: 500;">
                An Initiative by Jaydeep Kumar Basu's Lab, Department of Physics, IISc Bangalore
            </p>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-container">
            <button class="tab-btn active" onclick="switchTab('lipid-calculator')">
                ðŸ§ª Lipid Calculator
            </button>
            <button class="tab-btn" onclick="switchTab('protein-reconstitution')">
                ðŸ§¬ Protein Reconstitution
            </button>
        </div>

        <!-- Tab 1: Lipid Calculator -->
        <div id="lipid-calculator" class="tab-content active">
            <p class="subtitle">Professional Lipid's Volume Calculator for Membrane Preparation</p>

            <div class="section">
                <div class="section-title">Solution Parameters</div>
                <div class="input-group">
                    <label>Total Volume (Î¼L)</label>
                    <input type="number" id="totalVolume" value="1000" min="1">
                </div>
                <div class="input-group">
                    <label>Total Lipid Concentration (mg/mL)</label>
                    <input type="number" id="concentration" value="1" step="0.1" min="0.1">
                </div>
            </div>

            <div class="section">
                <div class="section-title">Lipid Components</div>
                <div id="lipidRows"></div>
                <button class="add-lipid-btn" onclick="addLipidRow()">+ Add Lipid</button>
                
                <div class="add-lipid-section">
                    <div style="font-weight: 600; color: #1976d2; margin-bottom: 10px;">âž• Register New Lipid</div>
                    <div class="add-lipid-form">
                        <div class="input-group">
                            <label>Lipid Name</label>
                            <input type="text" id="newLipidName" placeholder="e.g., DSPC">
                        </div>
                        <div class="input-group">
                            <label>MW (g/mol)</label>
                            <input type="number" id="newLipidMW" step="0.001" placeholder="e.g., 790.145">
                        </div>
                        <button class="save-lipid-btn" onclick="saveNewLipid()">Save Lipid</button>
                    </div>
                </div>
            </div>

            <button class="calculate-btn" onclick="calculateLipidVolumes()">Calculate Volumes</button>

            <div class="error" id="error-lipid"></div>
            <div class="results" id="results-lipid"></div>
        </div>

        <!-- Tab 2: Protein Reconstitution Calculator -->
        <div id="protein-reconstitution" class="tab-content">
            <p class="subtitle">Calculate protein stock concentrations for membrane reconstitution</p>

            <div class="section">
                <div class="section-title">Lipid Parameters</div>
                <div class="input-row">
                    <div class="input-group">
                        <label>Lipid Type</label>
                        <select id="lipidType" onchange="updateLipidMW()">
                            <option value="742.3223">ERGIC (MW: 742.32 g/mol)</option>
                            <option value="791.0573">PCPSPI (MW: 791.06 g/mol)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Lipid MW (g/mol)</label>
                        <input type="number" id="lipidMW" value="742.3223" step="0.0001" readonly>
                    </div>
                    <div class="input-group">
                        <label>Lipid Stock Concentration (mg/mL)</label>
                        <input type="number" id="lipidConc" value="1" step="0.01">
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Volume Parameters</div>
                <div class="input-row">
                    <div class="input-group">
                        <label>Lipid Volume (Î¼L)</label>
                        <input type="number" id="lipidVolume" value="200" step="1">
                    </div>
                    <div class="input-group">
                        <label>N Protein Volume (Î¼L)</label>
                        <input type="number" id="nProteinVolume" value="40" step="1">
                    </div>
                    <div class="input-group">
                        <label>MCT Volume (Î¼L)</label>
                        <input type="number" id="mctVolume" value="50" step="1">
                    </div>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="includeMCT" checked onchange="toggleMCT()">
                    <label for="includeMCT">Include MCT Protein</label>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Protein Parameters</div>
                <div class="input-row">
                    <div class="input-group">
                        <label>N Protein MW (g/mol)</label>
                        <input type="number" id="nProteinMW" value="52000" step="1">
                    </div>
                    <div class="input-group">
                        <label>MCT Protein MW (g/mol)</label>
                        <input type="number" id="mctMW" value="2651.77" step="0.01">
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Molecular Ratios</div>
                <div class="input-row">
                    <div class="input-group">
                        <label>Lipid : N Protein Ratio</label>
                        <input type="number" id="lipidNRatio" value="3" step="1" min="1">
                    </div>
                    <div class="input-group">
                        <label>Lipid : MCT Ratio</label>
                        <input type="number" id="lipidMCTRatio" value="60" step="1" min="1">
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Stock Solution Volume</div>
                <div class="input-row">
                    <div class="input-group">
                        <label>Stock Volume to Prepare (Î¼L)</label>
                        <input type="number" id="stockVolume" value="200" step="1">
                    </div>
                </div>
            </div>

            <button class="calculate-btn" onclick="calculateProteinConcentrations()">Calculate Concentrations</button>

            <div class="error" id="error-protein"></div>

            <div class="results" id="results-protein">
                <div class="section-title">ðŸ“Š Results</div>
                <div class="results-grid" id="resultsGrid"></div>
                
                <div style="margin-top: 30px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">Detailed Composition Table</h3>
                    <div style="overflow-x: auto;">
                        <table id="resultsTable"></table>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">Stock Preparation Instructions</h3>
                    <div style="overflow-x: auto;">
                        <table id="stockTable"></table>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">Reconstitution Recipe</h3>
                    <div style="overflow-x: auto;">
                        <table id="recipeTable"></table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>Â© 2024 LipoMix Pro | Developed by <a href="#">Biplab Bawali</a></p>
        <p style="font-size: 0.85em; margin-top: 5px; opacity: 0.9;">All rights reserved</p>
    </footer>

    <script>
        // ========== TAB SWITCHING ==========
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        // ========== LIPID CALCULATOR (TAB 1) ==========
        
        function loadLipidDatabase() {
            const savedLipids = localStorage.getItem('lipidDatabase');
            if (savedLipids) {
                return JSON.parse(savedLipids);
            }
            return {
                'Egg PC': 770.00,
                'POPE': 718.00,
                'Brain PS': 824.966,
                'Liver PI': 902.113,
                'Cholesterol': 386.65,
                'DGS-NTA Ni': 1004.94,
                'DOPC': 786.11,
                'DPPC': 734.04,
                'POPC': 760.08,
                'DOPE': 744.03,
                'Sphingomyelin': 703.00,
                'Cardiolipin': 1447.97
            };
        }

        function saveLipidDatabase(database) {
            localStorage.setItem('lipidDatabase', JSON.stringify(database));
        }

        let lipidDatabase = loadLipidDatabase();
        let lipidCount = 0;

        function saveNewLipid() {
            const name = document.getElementById('newLipidName').value.trim();
            const mw = parseFloat(document.getElementById('newLipidMW').value);

            if (!name || !mw || mw <= 0) {
                alert('Please enter valid lipid name and molecular weight.');
                return;
            }

            if (lipidDatabase[name]) {
                if (!confirm(`Lipid "${name}" already exists with MW ${lipidDatabase[name]}. Do you want to update it?`)) {
                    return;
                }
            }

            lipidDatabase[name] = mw;
            saveLipidDatabase(lipidDatabase);

            document.getElementById('newLipidName').value = '';
            document.getElementById('newLipidMW').value = '';

            alert(`Lipid "${name}" saved successfully!`);
            updateAllLipidDropdowns();
        }

        function updateAllLipidDropdowns() {
            const selects = document.querySelectorAll('.lipid-select');
            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = getLipidOptions();
                select.value = currentValue;
            });
        }

        function getLipidOptions() {
            let options = '<option value="">Select Lipid</option>';
            const sortedLipids = Object.keys(lipidDatabase).sort();
            for (let lipid of sortedLipids) {
                options += `<option value="${lipid}">${lipid} (MW: ${lipidDatabase[lipid]})</option>`;
            }
            return options;
        }

        function addLipidRow() {
            lipidCount++;
            const container = document.getElementById('lipidRows');
            const row = document.createElement('div');
            row.className = 'lipid-row';
            row.id = `lipid-${lipidCount}`;

            row.innerHTML = `
                <div class="input-group">
                    <label>Lipid</label>
                    <select class="lipid-select" data-id="${lipidCount}">${getLipidOptions()}</select>
                </div>
                <div class="input-group">
                    <label>Stock (mg/mL)</label>
                    <input type="number" class="stock-conc" data-id="${lipidCount}" step="0.01" min="0.01">
                </div>
                <div class="input-group">
                    <label>Molar Fraction</label>
                    <input type="number" class="molar-fraction" data-id="${lipidCount}" step="0.01" min="0" max="1">
                </div>
                <button class="remove-btn" onclick="removeLipidRow(${lipidCount})">Remove</button>
            `;
            container.appendChild(row);
        }

        function removeLipidRow(id) {
            const row = document.getElementById(`lipid-${id}`);
            if (row) row.remove();
        }

        function showError(message, type) {
            const errorDiv = document.getElementById(`error-${type}`);
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById(`results-${type}`).style.display = 'none';
        }

        function hideError(type) {
            document.getElementById(`error-${type}`).style.display = 'none';
        }

        function calculateLipidVolumes() {
            hideError('lipid');

            const totalVolume = parseFloat(document.getElementById('totalVolume').value);
            const concentration = parseFloat(document.getElementById('concentration').value);

            if (!totalVolume || !concentration) {
                showError('Please enter valid solution parameters.', 'lipid');
                return;
            }

            const lipids = [];
            const lipidSelects = document.querySelectorAll('.lipid-select');
            
            lipidSelects.forEach(select => {
                const id = select.dataset.id;
                const lipidName = select.value;
                const stockConc = parseFloat(document.querySelector(`.stock-conc[data-id="${id}"]`).value);
                const molarFraction = parseFloat(document.querySelector(`.molar-fraction[data-id="${id}"]`).value);

                if (lipidName && stockConc && molarFraction) {
                    lipids.push({
                        name: lipidName,
                        mw: lipidDatabase[lipidName],
                        stockConc: stockConc,
                        molarFraction: molarFraction
                    });
                }
            });

            if (lipids.length === 0) {
                showError('Please add at least one lipid with all required information.', 'lipid');
                return;
            }

            const totalFraction = lipids.reduce((sum, l) => sum + l.molarFraction, 0);
            if (Math.abs(totalFraction - 1.0) > 0.001) {
                showError(`Molar fractions must sum to 1.0 (current sum: ${totalFraction.toFixed(3)})`, 'lipid');
                return;
            }

            const avgMW = lipids.reduce((sum, l) => sum + (l.molarFraction * l.mw), 0);
            const totalMassMg = concentration * (totalVolume / 1000);
            const totalMassUg = totalMassMg * 1000;
            const totalMolesMmol = totalMassMg / avgMW;
            const totalMoles = totalMolesMmol * 1000;

            const results = lipids.map(lipid => {
                const moles = lipid.molarFraction * totalMoles;
                const molesInMmol = moles / 1000;
                const massInMg = molesInMmol * lipid.mw;
                const mass = massInMg * 1000;
                const volumeInMl = massInMg / lipid.stockConc;
                const volume = volumeInMl * 1000;
                
                return {
                    name: lipid.name,
                    moles: moles,
                    mass: mass,
                    volume: volume
                };
            });

            const totalLipidVolume = results.reduce((sum, r) => sum + r.volume, 0);
            const chloroformVolume = totalVolume - totalLipidVolume;

            displayLipidResults(results, chloroformVolume, totalLipidVolume, avgMW);
        }

        function displayLipidResults(lipidResults, chloroformVolume, totalLipidVolume, avgMW) {
            const resultsDiv = document.getElementById('results-lipid');
            let html = '<div class="section-title">ðŸ“Š Calculated Volumes</div>';
            
            html += `<div class="result-item">
                <span class="result-label">Average Molecular Weight:</span>
                <span class="result-value">${avgMW.toFixed(9)} g/mol</span>
            </div>`;

            lipidResults.forEach(result => {
                html += `<div class="result-item">
                    <span class="result-label">${result.name}:</span>
                    <span class="result-value">${result.volume.toFixed(9)} Î¼L</span>
                </div>`;
            });

            html += `<div class="result-item">
                <span class="result-label">Total Lipid Stock Volume:</span>
                <span class="result-value">${totalLipidVolume.toFixed(9)} Î¼L</span>
            </div>`;

            html += `<div class="result-item chloroform-result">
                <span class="result-label">Chloroform:</span>
                <span class="result-value">${chloroformVolume.toFixed(9)} Î¼L</span>
            </div>`;

            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        // ========== PROTEIN RECONSTITUTION CALCULATOR (TAB 2) ==========

        const AVOGADRO = 6.022e23;

        function updateLipidMW() {
            const lipidType = document.getElementById('lipidType');
            document.getElementById('lipidMW').value = lipidType.value;
        }

        function toggleMCT() {
            const includeMCT = document.getElementById('includeMCT').checked;
            const mctVolumeInput = document.getElementById('mctVolume');
            const lipidVolumeInput = document.getElementById('lipidVolume');
            
            if (!includeMCT) {
                const currentLipid = parseFloat(lipidVolumeInput.value);
                const currentMCT = parseFloat(mctVolumeInput.value);
                lipidVolumeInput.value = currentLipid + currentMCT;
                mctVolumeInput.disabled = true;
                document.getElementById('lipidMCTRatio').disabled = true;
            } else {
                mctVolumeInput.disabled = false;
                document.getElementById('lipidMCTRatio').disabled = false;
            }
        }

        function calculateProteinConcentrations() {
            hideError('protein');

            const lipidMW = parseFloat(document.getElementById('lipidMW').value);
            const lipidConc = parseFloat(document.getElementById('lipidConc').value);
            const lipidVolume = parseFloat(document.getElementById('lipidVolume').value);
            const nProteinVolume = parseFloat(document.getElementById('nProteinVolume').value);
            const mctVolume = parseFloat(document.getElementById('mctVolume').value);
            const nProteinMW = parseFloat(document.getElementById('nProteinMW').value);
            const mctMW = parseFloat(document.getElementById('mctMW').value);
            const lipidNRatio = parseFloat(document.getElementById('lipidNRatio').value);
            const lipidMCTRatio = parseFloat(document.getElementById('lipidMCTRatio').value);
            const stockVolume = parseFloat(document.getElementById('stockVolume').value);
            const includeMCT = document.getElementById('includeMCT').checked;

            if (!lipidMW || !lipidConc || !lipidVolume || !nProteinVolume || !nProteinMW || !lipidNRatio || !stockVolume) {
                showError('Please fill in all required fields.', 'protein');
                return;
            }

            if (includeMCT && (!mctVolume || !mctMW || !lipidMCTRatio)) {
                showError('Please fill in all MCT-related fields or uncheck "Include MCT Protein".', 'protein');
                return;
            }

            const lipidMassMg = lipidConc * (lipidVolume / 1000);
            const lipidMassUg = lipidMassMg * 1000;
            const lipidMolesMmol = lipidMassMg / lipidMW;
            const lipidMoles = lipidMolesMmol * 1000;
            const lipidMolecules = lipidMoles * 1e-6 * AVOGADRO;

            const nProteinMolecules = lipidMolecules / lipidNRatio;
            const nProteinMoles = nProteinMolecules / AVOGADRO * 1e6;
            const nProteinMolesMmol = nProteinMoles / 1000;
            const nProteinMassMg = nProteinMolesMmol * nProteinMW;
            const nProteinMassUg = nProteinMassMg * 1000;
            const nProteinConc = nProteinMassMg / (nProteinVolume / 1000);
            const nProteinStockMass = nProteinConc * (stockVolume / 1000);

            let mctMolecules, mctMoles, mctMassMg, mctMassUg, mctConc, mctStockMass;
            let totalVolume, totalMass;

            if (includeMCT) {
                mctMolecules = lipidMolecules / lipidMCTRatio;
                mctMoles = mctMolecules / AVOGADRO * 1e6;
                const mctMolesMmol = mctMoles / 1000;
                mctMassMg = mctMolesMmol * mctMW;
                mctMassUg = mctMassMg * 1000;
                mctConc = mctMassMg / (mctVolume / 1000);
                mctStockMass = mctConc * (stockVolume / 1000);

                totalVolume = lipidVolume + mctVolume + nProteinVolume;
                totalMass = lipidMassUg + mctMassUg + nProteinMassUg;
            } else {
                totalVolume = lipidVolume + nProteinVolume;
                totalMass = lipidMassUg + nProteinMassUg;
            }

            displayProteinResults({
                lipidMW, lipidConc, lipidVolume, lipidMassUg, lipidMoles, lipidMolecules,
                nProteinMW, nProteinVolume, nProteinMassUg, nProteinMoles, nProteinMolecules, nProteinConc, nProteinStockMass,
                mctMW, mctVolume, mctMassUg, mctMoles, mctMolecules, mctConc, mctStockMass,
                lipidNRatio, lipidMCTRatio, totalVolume, totalMass, stockVolume, includeMCT
            });
        }

        function displayProteinResults(data) {
            const resultsGrid = document.getElementById('resultsGrid');
            resultsGrid.innerHTML = '';

            const nCard = `
                <div class="result-card">
                    <h3>N Protein Stock</h3>
                    <div class="result-item">
                        <span class="result-label">Required Concentration:</span>
                        <span class="result-value">${data.nProteinConc.toFixed(9)} mg/mL</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Mass for ${data.stockVolume} Î¼L stock:</span>
                        <span class="result-value">${data.nProteinStockMass.toFixed(9)} mg</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Mass in final solution:</span>
                        <span class="result-value">${data.nProteinMassUg.toFixed(9)} Î¼g</span>
                    </div>
                </div>
            `;
            resultsGrid.innerHTML += nCard;

            if (data.includeMCT) {
                const mctCard = `
                    <div class="result-card">
                        <h3>MCT Protein Stock</h3>
                        <div class="result-item">
                            <span class="result-label">Required Concentration:</span>
                            <span class="result-value">${data.mctConc.toFixed(9)} mg/mL</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Mass for ${data.stockVolume} Î¼L stock:</span>
                            <span class="result-value">${data.mctStockMass.toFixed(9)} mg</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Mass in final solution:</span>
                            <span class="result-value">${data.mctMassUg.toFixed(9)} Î¼g</span>
                        </div>
                    </div>
                `;
                resultsGrid.innerHTML += mctCard;
            }

            const summaryCard = `
                <div class="result-card">
                    <h3>Solution Summary</h3>
                    <div class="result-item">
                        <span class="result-label">Total Volume:</span>
                        <span class="result-value">${data.totalVolume.toFixed(9)} Î¼L</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Total Mass:</span>
                        <span class="result-value">${data.totalMass.toFixed(9)} Î¼g</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Lipid:N Ratio:</span>
                        <span class="result-value">${data.lipidNRatio}:1</span>
                    </div>
                    ${data.includeMCT ? `
                    <div class="result-item">
                        <span class="result-label">Lipid:MCT Ratio:</span>
                        <span class="result-value">${data.lipidMCTRatio}:1</span>
                    </div>` : ''}
                </div>
            `;
            resultsGrid.innerHTML += summaryCard;

            const lipidType = document.getElementById('lipidType').options[document.getElementById('lipidType').selectedIndex].text.split(' ')[0];
            
            const lipidMicroMolar = (data.lipidMoles / data.totalVolume) * 1000000;
            const nProteinMicroMolar = (data.nProteinMoles / data.totalVolume) * 1000000;
            const mctMicroMolar = data.includeMCT ? (data.mctMoles / data.totalVolume) * 1000000 : 0;
            
            let tableHTML = `
                <tr>
                    <th>Component</th>
                    <th>Volume (Î¼L)</th>
                    <th>Mass (Î¼g)</th>
                    <th>Moles (Î¼mol)</th>
                    <th>Concentration (Î¼M)</th>
                    <th>Molecules</th>
                    <th>MW (g/mol)</th>
                </tr>
                <tr>
                    <td><strong>${lipidType} Lipids</strong></td>
                    <td>${data.lipidVolume.toFixed(9)}</td>
                    <td>${data.lipidMassUg.toFixed(9)}</td>
                    <td>${data.lipidMoles.toFixed(9)}</td>
                    <td>${lipidMicroMolar.toFixed(9)}</td>
                    <td>${data.lipidMolecules.toExponential(9)}</td>
                    <td>${data.lipidMW.toFixed(9)}</td>
                </tr>
                <tr>
                    <td><strong>N Protein</strong></td>
                    <td>${data.nProteinVolume.toFixed(9)}</td>
                    <td class="highlight">${data.nProteinMassUg.toFixed(9)}</td>
                    <td>${data.nProteinMoles.toFixed(9)}</td>
                    <td>${nProteinMicroMolar.toFixed(9)}</td>
                    <td>${data.nProteinMolecules.toExponential(9)}</td>
                    <td>${data.nProteinMW.toFixed(9)}</td>
                </tr>
            `;

            if (data.includeMCT) {
                tableHTML += `
                    <tr>
                        <td><strong>MCT Protein</strong></td>
                        <td>${data.mctVolume.toFixed(9)}</td>
                        <td class="highlight">${data.mctMassUg.toFixed(9)}</td>
                        <td>${data.mctMoles.toFixed(9)}</td>
                        <td>${mctMicroMolar.toFixed(9)}</td>
                        <td>${data.mctMolecules.toExponential(9)}</td>
                        <td>${data.mctMW.toFixed(9)}</td>
                    </tr>
                `;
            }

            tableHTML += `
                <tr style="background: #f0f0f0; font-weight: 600;">
                    <td><strong>TOTAL</strong></td>
                    <td>${data.totalVolume.toFixed(9)}</td>
                    <td>${data.totalMass.toFixed(9)}</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                </tr>
            `;

            document.getElementById('resultsTable').innerHTML = tableHTML;

            let stockHTML = `
                <tr>
                    <th>Component</th>
                    <th>Stock Volume</th>
                    <th>Mass to Dissolve</th>
                    <th>Final Concentration</th>
                </tr>
                <tr>
                    <td><strong>${lipidType} Lipids</strong></td>
                    <td>Already available</td>
                    <td>-</td>
                    <td>${data.lipidConc.toFixed(9)} mg/mL</td>
                </tr>
                <tr>
                    <td><strong>N Protein</strong></td>
                    <td>${data.stockVolume.toFixed(9)} Î¼L</td>
                    <td class="highlight">${data.nProteinStockMass.toFixed(9)} mg</td>
                    <td class="highlight">${data.nProteinConc.toFixed(9)} mg/mL</td>
                </tr>
            `;

            if (data.includeMCT) {
                stockHTML += `
                    <tr>
                        <td><strong>MCT Protein</strong></td>
                        <td>${data.stockVolume.toFixed(9)} Î¼L</td>
                        <td class="highlight">${data.mctStockMass.toFixed(9)} mg</td>
                        <td class="highlight">${data.mctConc.toFixed(9)} mg/mL</td>
                    </tr>
                `;
            }

            document.getElementById('stockTable').innerHTML = stockHTML;

            let recipeHTML = `
                <tr>
                    <th>Step</th>
                    <th>Component</th>
                    <th>Volume to Add</th>
                    <th>Concentration</th>
                </tr>
                <tr>
                    <td>1</td>
                    <td>${lipidType} Lipid Stock</td>
                    <td>${data.lipidVolume.toFixed(9)} Î¼L</td>
                    <td>${data.lipidConc.toFixed(9)} mg/mL</td>
                </tr>
            `;

            let step = 2;
            if (data.includeMCT) {
                recipeHTML += `
                    <tr>
                        <td>${step}</td>
                        <td>MCT Protein Stock</td>
                        <td>${data.mctVolume.toFixed(9)} Î¼L</td>
                        <td>${data.mctConc.toFixed(9)} mg/mL</td>
                    </tr>
                `;
                step++;
            }

            recipeHTML += `
                <tr>
                    <td>${step}</td>
                    <td>N Protein Stock</td>
                    <td>${data.nProteinVolume.toFixed(9)} Î¼L</td>
                    <td>${data.nProteinConc.toFixed(9)} mg/mL</td>
                </tr>
                <tr style="background: #e8f5e9; font-weight: 600;">
                    <td colspan="2"><strong>TOTAL VOLUME</strong></td>
                    <td colspan="2"><strong>${data.totalVolume.toFixed(9)} Î¼L</strong></td>
                </tr>
            `;

            document.getElementById('recipeTable').innerHTML = recipeHTML;
            document.getElementById('results-protein').style.display = 'block';
        }

        // Initialize lipid calculator with one row
        addLipidRow();
    </script>
</body>
</html>
